using System;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;
using System.Windows.Threading;

namespace wpfapp2
{
    public partial class AnaSayfa : Page
    {
        private string currentUser;

        private static DispatcherTimer timer;
        private static TimeSpan time = TimeSpan.FromMinutes(25);
        private static bool isWorkTime = true;
        private static bool isRunning = false;

        private MediaPlayer player = new MediaPlayer();

        public AnaSayfa(string user)
        {
            InitializeComponent();
            currentUser = user;

            WelcomeText.Text = $"HoÅŸ geldin, {currentUser} ðŸ‘‹";
            DateText.Text = DateTime.Now.ToString("dd MMMM yyyy, dddd");

            DispatcherTimer clockTimer = new DispatcherTimer();
            clockTimer.Interval = TimeSpan.FromSeconds(1);
            clockTimer.Tick += (s, e) => { ClockText.Text = DateTime.Now.ToString("HH:mm"); };
            clockTimer.Start();

            if (timer == null)
            {
                timer = new DispatcherTimer();
                timer.Interval = TimeSpan.FromSeconds(1);
            }

            timer.Tick -= Timer_Tick;
            timer.Tick += Timer_Tick;

            UpdateTimerDisplay();
            SyncButtonState();
            UpdateStatusText();
        }

        private void Ozet_Click(object sender, RoutedEventArgs e)
        {
            NavigationService?.Navigate(new OzetSayfasi(currentUser));
        }

        private void NotDefteri_Click(object sender, RoutedEventArgs e)
        {
            NavigationService?.Navigate(new NotDefteri(currentUser));
        }

        private void DersProgrami_Click(object sender, RoutedEventArgs e)
        {
            NavigationService?.Navigate(new DersProgrami(currentUser));
        }
        private void Flashcards_Click(object sender, RoutedEventArgs e)
        {
            NavigationService?.Navigate(new FlashcardsPage(currentUser));
        }
        private void BtnLogout_Click(object sender, RoutedEventArgs e)
        {
            NavigationService?.Navigate(new loginpage());
        }

        private void Timer_Tick(object sender, EventArgs e)
        {
            if (time.TotalSeconds > 0)
            {
                time = time.Subtract(TimeSpan.FromSeconds(1));
                UpdateTimerDisplay();
            }
            else
            {
                timer.Stop();
                isRunning = false;
                isWorkTime = !isWorkTime;

                try
                {
                    player.Open(new Uri(@"C:\Windows\Media\Alarm01.wav"));
                    player.Play();
                }
                catch
                {
                    System.Media.SystemSounds.Exclamation.Play();
                }

                if (isWorkTime)
                {
                    MessageBox.Show("Mola bitti! Tekrar Ã§alÄ±ÅŸmaya baÅŸla. ðŸ’ª", "SÃ¼re Doldu");
                    ResetPomodoroToWork();
                }
                else
                {
                    MessageBox.Show("Ã‡alÄ±ÅŸma sÃ¼resi bitti! Åžimdi 5 dakika mola. â˜•", "Tebrikler");
                    time = TimeSpan.FromMinutes(5);
                    UpdateStatusText();
                    UpdateTimerDisplay();
                    SyncButtonState();
                }
            }
        }

        private void BtnStartPomo_Click(object sender, RoutedEventArgs e)
        {
            if (!isRunning)
            {
                timer.Start();
                isRunning = true;
            }
            else
            {
                timer.Stop();
                isRunning = false;
            }
            SyncButtonState();
        }

        private void BtnResetPomo_Click(object sender, RoutedEventArgs e)
        {
            ResetPomodoroToWork();
            SyncButtonState();
        }

        private void ResetPomodoroToWork()
        {
            timer.Stop();
            isRunning = false;
            isWorkTime = true;
            time = TimeSpan.FromMinutes(25);

            UpdateTimerDisplay();
            UpdateStatusText();
        }

        private void UpdateTimerDisplay()
        {
            TxtTimer.Text = time.ToString(@"mm\:ss");
        }

        private void UpdateStatusText()
        {
            if (isWorkTime)
            {
                TxtStatus.Text = "ðŸŽ¯ Ã‡alÄ±ÅŸma ZamanÄ±";
                TimerBorder.BorderBrush = new SolidColorBrush((Color)ColorConverter.ConvertFromString("#E74C3C"));
            }
            else
            {
                TxtStatus.Text = "â˜• Mola ZamanÄ±";
                TimerBorder.BorderBrush = new SolidColorBrush((Color)ColorConverter.ConvertFromString("#2ECC71"));
            }
        }

        private void SyncButtonState()
        {
            if (FindName("BtnStart") is Button btn)
            {
                if (isRunning)
                {
                    btn.Content = "Durdur";
                    btn.Background = new SolidColorBrush((Color)ColorConverter.ConvertFromString("#E74C3C"));
                }
                else
                {
                    btn.Content = isWorkTime ? "BaÅŸlat" : "MolayÄ± BaÅŸlat";
                    btn.Background = new SolidColorBrush((Color)ColorConverter.ConvertFromString("#4A90E2"));
                }
            }
        }
    }
}
